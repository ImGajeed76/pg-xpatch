-- Test 05: Cache Functionality
-- Tests the shared memory LRU cache
-- Suppress NOTICE messages for cleaner test output
SET client_min_messages = warning;
-- Create a table for cache testing
CREATE TABLE test_cache (
    id INT,
    version INT,
    content TEXT NOT NULL
) USING xpatch;
SELECT xpatch.configure('test_cache',
    group_by => 'id',
    order_by => 'version',
    delta_columns => ARRAY['content']::text[]
);
 configure 
-----------
 
(1 row)

-- Insert some data
INSERT INTO test_cache VALUES (1, 1, 'Cache test version 1');
INSERT INTO test_cache VALUES (1, 2, 'Cache test version 2');
INSERT INTO test_cache VALUES (1, 3, 'Cache test version 3');
-- Get initial cache stats (values will vary based on previous activity)
-- Just verify the function works and returns reasonable values
SELECT 'Initial' as phase, 
       entries_count >= 0 AS has_entries,
       hit_count >= 0 AS has_hits,
       miss_count >= 0 AS has_misses
FROM xpatch_cache_stats();
  phase  | has_entries | has_hits | has_misses 
---------+-------------+----------+------------
 Initial | t           | t        | t
(1 row)

-- First query - should populate cache
SELECT * FROM test_cache ORDER BY version;
 id | version |       content        | _xp_seq 
----+---------+----------------------+---------
  1 |       1 | Cache test version 1 |       1
  1 |       2 | Cache test version 2 |       2
  1 |       3 | Cache test version 3 |       3
(3 rows)

-- Get cache stats after first query
SELECT 'After first query' as phase, 
       entries_count > 0 AS has_entries,
       hit_count >= 0 AS tracking_hits
FROM xpatch_cache_stats();
       phase       | has_entries | tracking_hits 
-------------------+-------------+---------------
 After first query | f           | t
(1 row)

-- Second query - should hit cache
SELECT * FROM test_cache ORDER BY version;
 id | version |       content        | _xp_seq 
----+---------+----------------------+---------
  1 |       1 | Cache test version 1 |       1
  1 |       2 | Cache test version 2 |       2
  1 |       3 | Cache test version 3 |       3
(3 rows)

-- Third query - more cache hits
SELECT * FROM test_cache ORDER BY version;
 id | version |       content        | _xp_seq 
----+---------+----------------------+---------
  1 |       1 | Cache test version 1 |       1
  1 |       2 | Cache test version 2 |       2
  1 |       3 | Cache test version 3 |       3
(3 rows)

-- Verify cache is tracking (hit count should increase with queries)
SELECT 'After repeated queries' as phase, 
       entries_count > 0 AS has_entries,
       cache_max_bytes > 0 AS has_max_size
FROM xpatch_cache_stats();
         phase          | has_entries | has_max_size 
------------------------+-------------+--------------
 After repeated queries | f           | f
(1 row)

-- Test cache across multiple tables
CREATE TABLE test_cache2 (
    id INT,
    version INT,
    data TEXT NOT NULL
) USING xpatch;
SELECT xpatch.configure('test_cache2',
    group_by => 'id',
    order_by => 'version',
    delta_columns => ARRAY['data']::text[]
);
 configure 
-----------
 
(1 row)

INSERT INTO test_cache2 VALUES (1, 1, 'Table 2 data');
INSERT INTO test_cache2 VALUES (1, 2, 'Table 2 data v2');
-- Query both tables
SELECT * FROM test_cache ORDER BY version;
 id | version |       content        | _xp_seq 
----+---------+----------------------+---------
  1 |       1 | Cache test version 1 |       1
  1 |       2 | Cache test version 2 |       2
  1 |       3 | Cache test version 3 |       3
(3 rows)

SELECT * FROM test_cache2 ORDER BY version;
 id | version |      data       | _xp_seq 
----+---------+-----------------+---------
  1 |       1 | Table 2 data    |       1
  1 |       2 | Table 2 data v2 |       2
(2 rows)

-- Cache should have entries from both tables
SELECT 'Multiple tables' as phase,
       entries_count > 0 AS has_entries
FROM xpatch_cache_stats();
      phase      | has_entries 
-----------------+-------------
 Multiple tables | f
(1 row)

-- Test cache max size is reported
SELECT cache_max_bytes > 0 AS has_max_size FROM xpatch_cache_stats();
 has_max_size 
--------------
 f
(1 row)

-- Clean up
DROP TABLE test_cache;
DROP TABLE test_cache2;
