-- Test 04: Keyframe Behavior
-- Tests keyframe creation and configuration
-- Suppress NOTICE messages for cleaner test output
SET client_min_messages = warning;
-- Create a table with small keyframe interval for testing
CREATE TABLE test_keyframes (
    id INT,
    seq INT,
    data TEXT NOT NULL
) USING xpatch;
SELECT xpatch.configure('test_keyframes',
    group_by => 'id',
    order_by => 'seq',
    delta_columns => ARRAY['data']::text[],
    keyframe_every => 5  -- Keyframe every 5 rows
);
 configure 
-----------
 
(1 row)

-- Insert 12 rows - should have keyframes at 1, 6, 11
INSERT INTO test_keyframes VALUES (1, 1, 'Version 1 - should be keyframe');
INSERT INTO test_keyframes VALUES (1, 2, 'Version 2 - delta');
INSERT INTO test_keyframes VALUES (1, 3, 'Version 3 - delta');
INSERT INTO test_keyframes VALUES (1, 4, 'Version 4 - delta');
INSERT INTO test_keyframes VALUES (1, 5, 'Version 5 - delta');
INSERT INTO test_keyframes VALUES (1, 6, 'Version 6 - should be keyframe');
INSERT INTO test_keyframes VALUES (1, 7, 'Version 7 - delta');
INSERT INTO test_keyframes VALUES (1, 8, 'Version 8 - delta');
INSERT INTO test_keyframes VALUES (1, 9, 'Version 9 - delta');
INSERT INTO test_keyframes VALUES (1, 10, 'Version 10 - delta');
INSERT INTO test_keyframes VALUES (1, 11, 'Version 11 - should be keyframe');
INSERT INTO test_keyframes VALUES (1, 12, 'Version 12 - delta');
-- Verify all data is retrievable
SELECT seq, left(data, 30) as data_preview FROM test_keyframes ORDER BY seq;
 seq |          data_preview          
-----+--------------------------------
   1 | Version 1 - should be keyframe
   2 | Version 2 - delta
   3 | Version 3 - delta
   4 | Version 4 - delta
   5 | Version 5 - delta
   6 | Version 6 - should be keyframe
   7 | Version 7 - delta
   8 | Version 8 - delta
   9 | Version 9 - delta
  10 | Version 10 - delta
  11 | Version 11 - should be keyfram
  12 | Version 12 - delta
(12 rows)

-- Check stats
SELECT total_rows FROM xpatch_stats('test_keyframes');
 total_rows 
------------
         12
(1 row)

-- Inspect to see storage details (keyframes vs deltas)
SELECT seq, is_keyframe, delta_size_bytes 
FROM xpatch_inspect('test_keyframes', 1) 
ORDER BY seq;
 seq | is_keyframe | delta_size_bytes 
-----+-------------+------------------
   0 | t           |               21
   1 | f           |               20
   2 | f           |               20
   3 | f           |               20
   4 | f           |               20
   5 | t           |               22
   6 | f           |               20
   7 | f           |               20
   8 | f           |               20
   9 | f           |               21
  10 | t           |               22
  11 | f           |               21
(12 rows)

-- Test compress_depth setting
CREATE TABLE test_compress_depth (
    id INT,
    version INT,
    content TEXT NOT NULL
) USING xpatch;
SELECT xpatch.configure('test_compress_depth',
    group_by => 'id',
    order_by => 'version',
    delta_columns => ARRAY['content']::text[],
    compress_depth => 3  -- Try 3 previous versions for best delta
);
 configure 
-----------
 
(1 row)

-- Insert versions with similar content
INSERT INTO test_compress_depth VALUES (1, 1, 'AAAAAAAAAA');
INSERT INTO test_compress_depth VALUES (1, 2, 'AAAAAAAAAB');  -- 1 char diff from v1
INSERT INTO test_compress_depth VALUES (1, 3, 'AAAAAAAAAC');  -- 1 char diff from v1, 1 from v2
INSERT INTO test_compress_depth VALUES (1, 4, 'AAAAAAAAAB');  -- Same as v2!
-- Verify retrieval
SELECT version, content FROM test_compress_depth ORDER BY version;
 version |  content   
---------+------------
       1 | AAAAAAAAAA
       2 | AAAAAAAAAB
       3 | AAAAAAAAAC
       4 | AAAAAAAAAB
(4 rows)

-- Clean up
DROP TABLE test_keyframes;
DROP TABLE test_compress_depth;
