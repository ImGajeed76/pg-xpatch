-- Test 06: Error Handling
-- Tests that appropriate errors are raised for invalid operations
-- Suppress NOTICE messages for cleaner test output
SET client_min_messages = warning;
-- Clean up from previous runs
DROP TABLE IF EXISTS test_errors;
-- Create a test table
CREATE TABLE test_errors (
    id INT,
    version INT,
    content TEXT
) USING xpatch;
SELECT xpatch.configure('test_errors',
    group_by => 'id',
    order_by => 'version',
    delta_columns => ARRAY['content']::text[]
);
 configure 
-----------
 
(1 row)

-- Insert initial data
INSERT INTO test_errors VALUES (1, 1, 'Initial version');
INSERT INTO test_errors VALUES (1, 2, 'Second version');
-- Test 1: UPDATE should fail
\set ON_ERROR_STOP off
UPDATE test_errors SET content = 'Modified' WHERE version = 1;
ERROR:  UPDATE is not supported on xpatch tables
HINT:  xpatch tables are append-only. Insert a new version instead.
\set ON_ERROR_STOP on
-- Test 2: DELETE should fail (basic DELETE without cascade)
\set ON_ERROR_STOP off
DELETE FROM test_errors WHERE version = 1;
\set ON_ERROR_STOP on
-- Test 3: Duplicate/out-of-order version values are now allowed
-- (auto-seq handles physical ordering, user version is just data)
INSERT INTO test_errors VALUES (1, 1, 'Duplicate version value');
INSERT INTO test_errors VALUES (1, 2, 'Same version value');
-- Test 4: NULL version is allowed (version column is just user data)
INSERT INTO test_errors VALUES (1, NULL, 'Null version');
-- Verify all rows exist (5 rows total: 2 original + 3 new)
SELECT id, version, content FROM test_errors ORDER BY _xp_seq;
 id | version |         content         
----+---------+-------------------------
  1 |       1 | Duplicate version value
  1 |       2 | Same version value
  1 |         | Null version
(3 rows)

-- Test 5: Valid insert still works
INSERT INTO test_errors VALUES (1, 10, 'Tenth version');
SELECT count(*) AS total_rows FROM test_errors;
 total_rows 
------------
          4
(1 row)

-- Test 6: Configure on non-xpatch table should fail
CREATE TABLE regular_table (id INT, data TEXT);
\set ON_ERROR_STOP off
SELECT xpatch.configure('regular_table', order_by => 'id');
ERROR:  Table "regular_table" is not using the xpatch access method
CONTEXT:  PL/pgSQL function xpatch.configure(regclass,text,text,text[],integer,integer,boolean) line 21 at RAISE
\set ON_ERROR_STOP on
DROP TABLE regular_table;
-- Clean up
DROP TABLE test_errors;
